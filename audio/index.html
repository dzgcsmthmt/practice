<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <title>dddfd</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1.0,user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no, email=no" />
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta name="HandheldFriendly" content="true">
    <meta name="MobileOptimized" content="320">
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <!-- <meta name="full-screen" content="yes"> -->
    <meta name="x5-fullscreen" content="true">
    <meta name="msapplication-tap-highlight" content="no">
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .pie {
            width: 100px;
            height: 100px;
            border-radius: 50px;
            /*background: #3872cd;*/
            /*background-image: linear-gradient(to right, transparent 50%, #3872cd 0);*/
            margin: 50px auto;
            /*overflow: hidden;*/
            position: relative;
        }

        .switch {
            position: absolute;
            left: 4px;
            top: 4px;
            width: 92px;
            height: 92px;
            background: #fff;
            border-radius: 46px;
            text-align: center;
            line-height: 92px;
            box-sizing: border-box;
            z-index: 222;
        }
        .play{
            width: 84px;
            height: 84px;
            margin: 4px 0 0 4px;
            background: #3872cd;
            border-radius: 42px;
        }

        .play svg{
            width: 13px;
            height: 15px;
        }

        #fan1 {
            /*display: block;
            margin-left: 50px;
            width: 50px;
            height: 100px;
            border-radius: 0 50px 50px 0;*/
            /*
            小于180度

            */
            /*大于180*/
            /*background-color: inherit;
            -webkit-transform-origin: left;
            transform-origin: left;
            transform: rotate(200deg);*/
            position: absolute;
            width: 20px;
            height: 50px;
            background: #3872cd;
            top: 0;
            left: 40px;
            -webkit-transform-origin: bottom center;
            transform-origin: bottom center;
            transform: rotate(0deg);
            -webkit-animation: spin1 2s linear infinite;
            animation: spin1 2s linear infinite;
        }

        #fan{
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
            -webkit-animation: spin1 2s linear infinite;
            animation: spin1 2s linear infinite;
            z-index: 2;
        }


        .animate1 {
            /*
                animation-delay: 可以是负值，立即执行，从关键帧 value / time的阶段开始执行
                如执行时间30s delay -15s 从50%的状态开始执行
                animation-timing-function新增加了step的属性
                step-start | step-end | steps([, [ start | end ] ]?)
                可以分成几步执行，不是连续的动画，而且按步数一帧一帧执行
                可以参照https://www.qianduan.net/css3-animation/
            */
            -webkit-animation: spin 1s linear infinite, bg 2s step-end infinite;
            animation: spin 1s linear infinite, bg 2s step-end infinite;
        }

        @-webkit-keyframes spin {
            to {
                -webkit-transform: rotate(180deg);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(180deg);
            }
        }

        @-webkit-keyframes spin1 {
            to {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin1 {
            to {
                transform: rotate(360deg);
            }
        }

        @-webkit-keyframes bg {
            50% {
                background: #3872cd;
            }
        }

        @keyframes bg {
            50% {
                background: #3872cd;
            }
        }



        .bar{
            margin: 0 50px 15px 15px;
            height: 4px;
            background: #999;
            position: relative;
            user-select: none;
        }

        #track{
            position: absolute;
            height: 100%;
            width: 0;
            top: 0;
            left: 0;
            background: #3872cd;
        }
        #indicator{
            height: 16px;
            width: 16px;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
            top: -6px;
            position: absolute;
            z-index: 222;
        }
        #indicator:after{
            content: '';
            width: 4px;
            height: 4px;
            background: #3872cd;
            border-radius: 2px;
            position: absolute;
            right: 0;
            left: 0;
            top: 0;
            bottom: 0;
            margin: auto;
        }

        #test{
            width: 100px;
            height: 100px;
            background: #3872cd;
            border-radius: 50px;
        }
        #mask{
            width: 50px;
            margin-left: 50px;
            height: 100px;
            border-radius: 0 50px 50px 0;
            background: #fff;
        }
    </style>
</head>

<body>
    <div class="pie">
        <img src="loading.png" id="fan">
        <div class="switch">
            <div class="play" id="btn">
                <svg viewBox="0 0 13 15" id="icon-play" xmlns="http://www.w3.org/2000/svg"><path d="M-.003 7.107L0 0l6.157 3.55 6.153 3.557-6.153 3.556L0 14.215" fill="#FFF" fill-rule="evenodd"/></svg>
                <svg viewBox="0 0 10 15" id="icon-pause" xmlns="http://www.w3.org/2000/svg"><g fill="#FFF" fill-rule="evenodd"><path d="M8 0h1c.552 0 1 .448 1 1v13c0 .552-.448 1-1 1H8c-.552 0-1-.448-1-1V1c0-.552.448-1 1-1zM1 0h1c.552 0 1 .448 1 1v13c0 .552-.448 1-1 1H1c-.552 0-1-.448-1-1V1c0-.552.448-1 1-1z"/></g></svg>
            </div>
        </div>
    </div>

    <!-- <div class="track">
        <input type="range" id="range">
        <div id="mask"></div>
    </div> -->

    <div class="bar">
        <div id="track"></div>
        <div id="indicator"></div>
    </div>
    <div class="">
        <div id="current">已播放0分00秒</div>
        <div id="duration">总时长45分12秒</div>
    </div>
    <div id="state" style="background:red;"></div>
    <div id="buffer"></div>

    <!-- <audio src="11.m4a" controls id="audio"></audio> -->
    <audio src="one_sweet_day.mp3" controls id="audio"></audio>

    <!-- <div id="test">
        <div id="mask"></div>
    </div> -->

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/2.1.3/jquery.js"></script>
    <script type="text/javascript">
        var oBtn = document.getElementById('btn');
        var isTouchSupported = 'ontouchstart' in window;
        var tap = isTouchSupported ? 'touchstart' : 'click';
        var start = isTouchSupported ? 'touchstart' : 'mousedown';
        var move = isTouchSupported ? 'touchmove' : 'mousemove';
        var end = isTouchSupported ? 'touchend' : 'mouseup';
        var oAudio = document.getElementById('audio');
        var oFan = document.getElementById('fan');
        var oRange = document.getElementById('range');
        var oMask = document.getElementById('mask');
        var oTrack = document.getElementById('track');
        var oIndicator = document.getElementById('indicator');
        var oCurrent = document.getElementById('current');
        var duration = 0;
        var status = 'paused';
        var canPlay = false;
        var ended = true;
        var timer;

        //m4a能支持低版本手机的大音频播放，mp3在vivo A33中播放会有问题
        //safari 不支持canplaythrough事件
        //部分浏览器可以缓存音频,oAudio.readyState == 4

        timer = setInterval(function(){
            var bufferedTime = oAudio.buffered.length && oAudio.buffered.end(0);
            console.log(bufferedTime);
            // document.getElementById('state').textContent = oAudio.readyState;
            document.getElementById('buffer').textContent = bufferedTime;
            if(bufferedTime == duration){
                document.getElementById('buffer').textContent = 'done';
                clearInterval(timer);
            }
        },150);

        // oAudio.addEventListener('loadstart',function(){console.log('loadstart')},false);
        // oAudio.addEventListener('durationchange',function(){console.log('durationchange')},false);
        // oAudio.addEventListener('loadedmetadata',function(){
        //     duration = oAudio.duration;
        //     document.getElementById('duration').textContent = '总时长' + format(duration).sub(2);
        // },false);
        // oAudio.addEventListener('loadeddata',function(){console.log('loadeddata')},false);
        // oAudio.addEventListener('progress',function(){
        //     var ranges = [];
        //     for(var i = 0; i < oAudio.buffered.length; i ++){
        //         ranges.push([
        //             oAudio.buffered.start(i),
        //             oAudio.buffered.end(i)
        //         ]);
        //     }
        //     console.log(ranges);
        // },false);
        // oAudio.addEventListener('canplay',function(){console.log('canplay')},false);
        // oAudio.addEventListener('canplaythrough',function(){console.log('canplaythrough')},false);

        if(oAudio.readyState == 4){
            duration = oAudio.duration;
            document.getElementById('duration').textContent = '总时长' + format(duration).substr(3);
            audioLoaded();
        }else{
            oAudio.addEventListener('loadedmetadata',function(){
                duration = oAudio.duration;
                document.getElementById('duration').textContent = 'IOS总时长' + format(duration).substr(3);
            },false);
            if(isIOS()){
                oFan.offsetParent.removeChild(oFan);
                document.getElementById('state').textContent = oAudio.readyState;
            }else{
                oAudio.addEventListener('canplaythrough', function() {
                    audioLoaded();
                }, false);
            }
        }

        oBtn.addEventListener(tap, function() {
            document.getElementById('state').textContent = oAudio.readyState;
            // if (oAudio.readyState != 4) {
            //     return;
            // }

            if (status == 'paused') {
                oAudio.play();
                status = 'playing';
                ended = false;
                document.getElementById('icon-play').style.display = 'none';
                document.getElementById('icon-pause').style.display = 'inline-block';
            } else {
                oAudio.pause();
                status = 'paused';
                document.getElementById('icon-play').style.display = 'inline-block';
                document.getElementById('icon-pause').style.display = 'none';
            }
        }, false);

        var disX = oIndicator.offsetParent.offsetLeft;
        var w = oIndicator.offsetParent.offsetWidth;
        var iW = oIndicator.offsetWidth;
        var tW = w - iW;

        oIndicator.addEventListener(start,function(){
            document.addEventListener(move,touchmove,false);
            document.addEventListener(end,touchend,false);
            function touchmove(ev){
                ev.preventDefault();
                var x = ev.touches ? ev.touches[0].pageX : ev.pageX;
                var left = x - disX;
                var val = Math.max(left,0);
                val = Math.min(tW,val);
                var currentTime = duration * val / tW;
                if(currentTime == 0){
                    val = 0;
                }
                if(!ended){
                    updateProcess(val,currentTime);
                    oAudio.currentTime = currentTime;
                }
            }

            function touchend(ev){
                document.removeEventListener(move,touchmove,false);
                document.removeEventListener(end,touchend,false);
            }

        },false);

        oAudio.addEventListener('timeupdate', function() {
            var ratio = oAudio.currentTime / duration;
            var val = tW * ratio;
            updateProcess(val,oAudio.currentTime);
            // console.log(oAudio.buffered.end(0));
        }, false);

        oAudio.addEventListener('ended', function() {
            reset();
        }, false);

        oAudio.addEventListener("seeked", function() {
            state.textContent = oAudio.currentTime;
            if((!oAudio.currentTime) && status == 'playing'){
                oAudio.play();
                var ratio = oAudio.currentTime / duration;
                var val = tW * ratio;
                updateProcess(val,oAudio.currentTime);
            }
        }, false);

        function updateProcess(val,currentTime){
            oIndicator.style.left = val + 'px';
            oTrack.style.width = val + 'px';
            oCurrent.textContent = format(currentTime);
        }

        function audioLoaded(){
            oFan.offsetParent.removeChild(oFan);
            document.querySelector('.pie').style.backgroundColor = '#3872cd';
        }

        function reset() {
            ended = true;
            status = 'paused';
            document.getElementById('icon-play').style.display = 'inline-block';
            document.getElementById('icon-pause').style.display = 'none';
            updateProcess(0,0);
        }

        function format(seconds){
            seconds = Math.round(seconds);
            var m = Math.floor(seconds / 60);
            var s = seconds % 60;
            return '已播放' + m + '分' + s + '秒';

        }

        function isIOS(){
            return /IOS|iPad|iPhone|iPod/i.test(navigator.userAgent) && !window.MSStream
        }

    </script>

</body>

</html>
